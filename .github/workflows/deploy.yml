name: Deploy Backend & Frontend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p $HOME/.ssh
          ssh-keyscan -H 31.97.226.111 >> $HOME/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 31.97.226.111
          username: root
          key: |
            -----BEGIN OPENSSH PRIVATE KEY-----
            b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
            QyNTUxOQAAACBXB4iplWwisVppwA1bSHR9yOK1usTxigvEUeafmaxKrQAAAJiy/ptAsv6b
            QAAAAAtzc2gtZWQyNTUxOQAAACBXB4iplWwisVppwA1bSHR9yOK1usTxigvEUeafmaxKrQ
            AAAEC3SqwwYZ9j0oE6oG8ef5XeyNcoPHvweISG2qwQCcrNa1cHiKmVbCKxWmnADVtIdH3I
            4rW6xPGKC8RR5p+ZrEqtAAAADmdpdGh1Yi1hY3Rpb25zAQIDBAUGBw==
            -----END OPENSSH PRIVATE KEY-----
          port: 22
          debug: true
          script: |

            set -e

            echo "üöÄ Deploying BACKEND"
            cd /root/luxuriousonly/backend || { echo "‚ùå Backend directory not found!"; exit 1; }

            # Configure git to avoid prompts
            git config --global --add safe.directory /root/luxuriousonly/backend || true
            git config pull.rebase false || true

            echo "üì• Pulling latest changes..."
            timeout 60 git pull origin main || { echo "‚ö†Ô∏è Git pull failed or timed out"; exit 1; }

            echo "üì¶ Installing dependencies..."
            npm install

            echo "üî® Building..."
            npm run build || true

            echo "üîÑ Reloading PM2..."
            pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js

            echo "‚úÖ Backend deployed successfully"

            echo "üöÄ Deploying FRONTEND"
            cd /root/luxuriousonly/frontend || { echo "‚ùå Frontend directory not found!"; exit 1; }

            # Configure git to avoid prompts
            git config --global --add safe.directory /root/luxuriousonly/frontend || true
            git config pull.rebase false || true

            echo "üì• Pulling latest changes..."
            timeout 60 git pull origin main || { echo "‚ö†Ô∏è Git pull failed or timed out"; exit 1; }

            echo "üì¶ Installing dependencies..."
            npm install

            echo "üî® Building..."
            npm run build

            echo "üîÑ Reloading PM2..."
            pm2 reload frontend || pm2 start npm --name "frontend" -- start

            echo "‚úÖ Frontend deployed successfully"
